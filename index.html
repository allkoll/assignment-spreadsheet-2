<!DOCTYPE html>
<html>
<head>
    <title>Assignment Spreadsheet</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 {
            text-align: center;
        }
        #controls {
            margin-bottom: 20px;
            text-align: center;
        }
        #controls button {
            margin: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }
        th, td {
            border: 1px solid #000;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }
        th[contenteditable="true"]:focus, td[contenteditable="true"]:focus {
            outline: 2px solid blue;
        }
        .score-select, .skill-select {
            width: 100%;
            padding: 2px;
            color: #000;
            font-weight: bold;
            border: none;
            outline: none;
            appearance: none;
        }
        .score-4 {
            background-color: #00c5ff;
        }
        .score-3 {
            background-color: #00ff04;
        }
        .score-2 {
            background-color: #fdff00;
        }
        .score-1 {
            background-color: #ff1837;
        }
        .score-N {
            background-color: #ff00a7;
        }
        .score-default {
            background-color: #cccccc;
        }
        .chart-cell {
            width: 150px;
        }
        #downloadBtn {
            display: block;
            margin: 20px auto;
        }
        .proficiency-cell {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        .letter-grade {
            font-weight: bold;
        }
        .rotate-header {
            transform: rotate(-90deg);
            writing-mode: vertical-lr;
            white-space: nowrap;
            height: 150px;
        }
        .sep-average {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Assignment Spreadsheet</h1>

    <div id="controls">
        <button id="addStudentBtn">Add Student</button>
        <button id="addAssessmentBtn">Add Assessment</button>
        <button id="downloadBtn">Download PDF</button>
    </div>

    <table id="gradeTable">
        <thead>
            <tr id="headerRow">
                <th>Assessment Name</th>
                <th>SEP Skill</th>
                <th>Letter Grade</th>
                <th>SEP2 Avg</th>
                <th>SEP4 Avg</th>
                <th>SEP6 Avg</th>
                <!-- Student names will be added here -->
            </tr>
        </thead>
        <tbody>
            <!-- Assessment rows will be added here -->
        </tbody>
    </table>

    <!-- Include Chart.js, ChartDataLabels, jsPDF, and html2canvas from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>

    <script>
        // Initialize variables
        const gradeTable = document.getElementById('gradeTable');
        const headerRow = document.getElementById('headerRow');
        const tableBody = gradeTable.querySelector('tbody');
        let students = [];
        let assessments = [];
        const seps = ['SEP2', 'SEP4', 'SEP6'];

        // Function to initialize the table with 10 students and 10 assessments
        function initializeTable() {
            for (let i = 1; i <= 10; i++) {
                addStudent('Student ' + i);
            }
            for (let i = 0; i < 10; i++) {
                addAssessment('Assessment ' + (i + 1));
            }
        }

        // Function to add a new student
        document.getElementById('addStudentBtn').addEventListener('click', function() {
            const studentNumber = students.length + 1;
            addStudent('Student ' + studentNumber);
        });

        // Function to add a new assessment
        document.getElementById('addAssessmentBtn').addEventListener('click', function() {
            const assessmentNumber = assessments.length + 1;
            addAssessment('Assessment ' + assessmentNumber);
        });

        // Function to add a student
        function addStudent(studentName) {
            const studentIndex = students.length;
            students.push({ name: studentName });

            // Add student name cell to header row
            const studentCell = document.createElement('th');
            studentCell.contentEditable = true;
            studentCell.className = 'rotate-header';
            studentCell.textContent = studentName;
            studentCell.dataset.studentIndex = studentIndex;
            headerRow.appendChild(studentCell);

            // Update existing assessment rows with new student score cells
            const assessmentRows = tableBody.querySelectorAll('.assessment-row');
            assessmentRows.forEach(row => {
                const scoreCell = createScoreCell(studentIndex, row.dataset.assessmentIndex);
                row.appendChild(scoreCell);
            });
        }

        // Function to add an assessment
        function addAssessment(assessmentName) {
            const assessmentIndex = assessments.length;
            assessments.push({ name: assessmentName, sep: 'SEP2' });

            const row = document.createElement('tr');
            row.dataset.assessmentIndex = assessmentIndex;
            row.className = 'assessment-row';

            // Assessment name cell
            const assessmentCell = document.createElement('td');
            assessmentCell.contentEditable = true;
            assessmentCell.textContent = assessmentName;
            assessmentCell.dataset.assessmentIndex = assessmentIndex;
            row.appendChild(assessmentCell);

            // SEP selection cell
            const sepCell = document.createElement('td');
            const sepSelect = document.createElement('select');
            sepSelect.className = 'skill-select';
            seps.forEach(sep => {
                const option = document.createElement('option');
                option.value = sep;
                option.textContent = sep;
                sepSelect.appendChild(option);
            });
            sepSelect.addEventListener('change', function() {
                assessments[assessmentIndex].sep = sepSelect.value;
                calculateSEPAverages();
                calculateLetterGrades();
            });
            sepCell.appendChild(sepSelect);
            row.appendChild(sepCell);

            // Letter Grade placeholder (empty cell)
            const letterCell = document.createElement('td');
            letterCell.textContent = '';
            row.appendChild(letterCell);

            // SEP Average placeholders (empty cells)
            const sep2Cell = document.createElement('td');
            sep2Cell.textContent = '';
            row.appendChild(sep2Cell);

            const sep4Cell = document.createElement('td');
            sep4Cell.textContent = '';
            row.appendChild(sep4Cell);

            const sep6Cell = document.createElement('td');
            sep6Cell.textContent = '';
            row.appendChild(sep6Cell);

            // Score cells for each student
            for (let i = 0; i < students.length; i++) {
                const scoreCell = createScoreCell(i, assessmentIndex);
                row.appendChild(scoreCell);
            }

            tableBody.appendChild(row);

            updateProficiencyPercentages();
        }

        // Function to create score cell
        function createScoreCell(studentIndex, assessmentIndex) {
            const scoreCell = document.createElement('td');

            const select = document.createElement('select');
            select.className = 'score-select score-default';
            select.dataset.studentIndex = studentIndex;
            select.dataset.assessmentIndex = assessmentIndex;
            const scores = ['', 4, 3, 2, 1, 'N'];
            scores.forEach(score => {
                const option = document.createElement('option');
                option.value = score;
                option.text = score;
                select.appendChild(option);
            });

            // Event listener to update calculations
            select.addEventListener('change', function() {
                updateCellColor(select);
                updateProficiencyPercentages();
                calculateSEPAverages();
                calculateLetterGrades();
            });

            scoreCell.appendChild(select);
            updateCellColor(select);

            return scoreCell;
        }

        // Function to update cell background color
        function updateCellColor(selectElement) {
            const score = selectElement.value;
            selectElement.className = 'score-select';
            if (score === '') {
                selectElement.classList.add('score-default');
            } else {
                selectElement.classList.add('score-' + score);
            }
        }

        // Function to calculate SEP averages
        function calculateSEPAverages() {
            students.forEach((student, studentIndex) => {
                const sepSums = {'SEP2': 0, 'SEP4': 0, 'SEP6': 0};
                const sepCounts = {'SEP2': 0, 'SEP4': 0, 'SEP6': 0};

                assessments.forEach((assessment, assessmentIndex) => {
                    const select = document.querySelector(`.score-select[data-student-index="${studentIndex}"][data-assessment-index="${assessmentIndex}"]`);
                    const score = select.value;
                    if (score !== '' && score !== 'N') {
                        sepSums[assessment.sep] += parseFloat(score);
                        sepCounts[assessment.sep]++;
                    }
                });

                // Update SEP averages in the first assessment row
                const firstRow = tableBody.querySelector('.assessment-row');
                const sep2Cell = firstRow.querySelectorAll('td')[3];
                const sep4Cell = firstRow.querySelectorAll('td')[4];
                const sep6Cell = firstRow.querySelectorAll('td')[5];

                if (sepCounts['SEP2'] > 0) {
                    const average = (sepSums['SEP2'] / sepCounts['SEP2']).toFixed(2);
                    sep2Cell.textContent = average;
                    sep2Cell.dataset.average = average;
                } else {
                    sep2Cell.textContent = 'N/A';
                    sep2Cell.dataset.average = '';
                }

                if (sepCounts['SEP4'] > 0) {
                    const average = (sepSums['SEP4'] / sepCounts['SEP4']).toFixed(2);
                    sep4Cell.textContent = average;
                    sep4Cell.dataset.average = average;
                } else {
                    sep4Cell.textContent = 'N/A';
                    sep4Cell.dataset.average = '';
                }

                if (sepCounts['SEP6'] > 0) {
                    const average = (sepSums['SEP6'] / sepCounts['SEP6']).toFixed(2);
                    sep6Cell.textContent = average;
                    sep6Cell.dataset.average = average;
                } else {
                    sep6Cell.textContent = 'N/A';
                    sep6Cell.dataset.average = '';
                }
            });
        }

        // Function to calculate letter grades
        function calculateLetterGrades() {
            students.forEach((student, studentIndex) => {
                const sepAverages = [];
                assessments.forEach((assessment, assessmentIndex) => {
                    const select = document.querySelector(`.score-select[data-student-index="${studentIndex}"][data-assessment-index="${assessmentIndex}"]`);
                    const score = select.value;
                    if (score !== '' && score !== 'N') {
                        sepAverages.push(parseFloat(score));
                    }
                });

                const firstRow = tableBody.querySelector('.assessment-row');
                const letterCell = firstRow.querySelectorAll('td')[2];

                if (sepAverages.length > 0) {
                    const overallAverage = sepAverages.reduce((a, b) => a + b, 0) / sepAverages.length;
                    let letterGrade = '';
                    if (overallAverage >= 3.5) {
                        letterGrade = 'A';
                    } else if (overallAverage >= 2.5) {
                        letterGrade = 'B';
                    } else if (overallAverage >= 1.5) {
                        letterGrade = 'C';
                    } else {
                        letterGrade = 'F';
                    }
                    letterCell.textContent = letterGrade;
                } else {
                    letterCell.textContent = 'N/A';
                }
            });
        }

        // Function to update proficiency percentages
        function updateProficiencyPercentages() {
            assessments.forEach((assessment, assessmentIndex) => {
                let total = 0;
                let proficientCount = 0;
                students.forEach((student, studentIndex) => {
                    const select = document.querySelector(`.score-select[data-student-index="${studentIndex}"][data-assessment-index="${assessmentIndex}"]`);
                    const score = select.value;
                    if (score !== '') {
                        total++;
                        if (score === '3' || score === '4') {
                            proficientCount++;
                        }
                    }
                });
                const proficiencyPercentage = total > 0 ? ((proficientCount / total) * 100).toFixed(2) + '%' : '0%';
                const row = tableBody.querySelector(`tr[data-assessment-index="${assessmentIndex}"]`);
                const proficiencyCell = row.querySelector('.proficiency-cell');
                if (!proficiencyCell) {
                    const newCell = document.createElement('td');
                    newCell.className = 'proficiency-cell';
                    newCell.textContent = proficiencyPercentage;
                    row.insertBefore(newCell, row.querySelectorAll('td')[2]);
                } else {
                    proficiencyCell.textContent = proficiencyPercentage;
                }
            });
        }

        // Initialize the table
        initializeTable();

        // PDF Download functionality
        document.getElementById('downloadBtn').addEventListener('click', function() {
            // Disable the download button to prevent multiple clicks
            this.disabled = true;
            this.textContent = 'Generating PDF...';

            // Wait for charts to render
            setTimeout(() => {
                // Capture the entire body
                html2canvas(document.body, {scale: 2}).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('l', 'mm', 'a4'); // Landscape orientation

                    // Calculate the number of pages needed
                    const imgWidth = 297; // A4 width in mm
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;

                    let position = 0;
                    let heightLeft = imgHeight;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= 210;

                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= 210;
                    }

                    pdf.save('AssignmentSpreadsheet.pdf');

                    // Re-enable the download button
                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('downloadBtn').textContent = 'Download PDF';
                });
            }, 1000); // Adjust the timeout as needed
        });
    </script>
</body>
</html>
